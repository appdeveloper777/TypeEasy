services:
  # --- SERVICIO MYSQL ---
  # mysql:
  #  image: mysql:8.0
  # container_name: typeeasy_mysql
  #environment:
  # MYSQL_ROOT_PASSWORD: rootpassword
  #MYSQL_DATABASE: test_db
  #ports:
  # - "3307:3306"
  #volumes:
  # - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # --- SERVICIO DE LA API WEB (Sin cambios) ---
  api:
    #depends_on:
    # - mysql
    build:
      context: .
      dockerfile: src/Dockerfile
      target: api
    image: typeeasy-api
    ports:
      - "8080:8080"
    environment:
      - TYPEEASY_DEBUG=0
      # Configuración de MySQL - Cambia estos valores según tu servidor
      - MYSQL_HOST=mysql # Nombre del servicio MySQL en Docker
      - MYSQL_PORT=3306 # Puerto interno de MySQL
      - MYSQL_USER=root # Usuario de MySQL
      - MYSQL_PASSWORD=rootpassword # Contraseña de MySQL
      - MYSQL_DATABASE=meri # Nombre de la base de datos
    volumes:
      - ./typeeasycode/apis:/app/apis
      - ./typeeasycode/models:/app/models
      - ./typeeasycode/settings:/app/settings

  # --- SERVICIO DEL INTÉRPRETE (Sin cambios) ---
  typeeasy:
    build:
      context: .
      dockerfile: src/Dockerfile
      target: typeeasy
    volumes:
      - ./typeeasycode:/code
    environment:
      - TYPEEASY_DEBUG=0
    working_dir: /code
    entrypoint: [ "/typeeasy/typeeasy" ]

  # --- ¡NUEVO! SERVICIO DEL AGENTE (n8n) ---
  agent:
    build:
      context: .
      dockerfile: src/Dockerfile
      target: agent # Apunta a la nueva etapa 6 del Dockerfile
    image: typeeasy-agent
    ports:
      - "8081:8081" # Expone el puerto del agente
    environment:
      - TYPEEASY_DEBUG=0
    # El CMD del Dockerfile ya es ["./servidor_agent", "agente_chat_whatsapp.te"]

    depends_on:
      - nlu
      - api_mock

  # --- MOCK NLU service (simple HTTP adapter) ---
  nlu:
    build:
      context: ./tools/nlu_mock
    image: typeeasy-nlu-mock
    ports:
      - "5000:5000"

  # --- MOCK API service (menu provider) ---
  api_mock:
    build:
      context: ./tools/api_mock
    image: typeeasy-api-mock
    ports:
      - "5001:5001"

  # --- ¡NUEVO! SERVICIO GEMINI AI ---
  gemini:
    build:
      context: ./tools/gemini_service
    image: typeeasy-gemini-ai
    ports:
      - "5003:5003"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash-latest}

  # --- ¡NUEVO! AGENTE CON GEMINI (alternativo al agent original) ---
  agent_gemini:
    build:
      context: .
      dockerfile: src/Dockerfile
      target: agent
    image: typeeasy-agent-gemini
    ports:
      - "8082:8081" # Puerto diferente para no conflictuar con agent original
    environment:
      - TYPEEASY_DEBUG=1
    # Usar el nuevo agente con Gemini
    command: [ "./servidor_agent", "agente_gemini_whatsapp.te" ]
    depends_on:
      - api_mock
      - gemini

  whatsapp_adapter:
    build:
      context: ./tools/whatsapp_adapter
    image: typeeasy-whatsapp-adapter
    ports:
      - "5002:5002"
    environment:
      - AGENT_WEBHOOK=http://agent_gemini:8081/whatsapp_hook
      - WHATSAPP_PROVIDER=${WHATSAPP_PROVIDER:-waha} # waha, meta, or twilio
      - WAHA_API_URL=http://waha:3000
      - WAHA_API_KEY=${WAHA_API_KEY:-typeeasy_waha_key_2024}
      # Meta WhatsApp Cloud API
      - META_VERIFY_TOKEN=${META_VERIFY_TOKEN}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_WHATSAPP_TOKEN=${META_WHATSAPP_TOKEN}
      - META_WHATSAPP_PHONE_ID=${META_WHATSAPP_PHONE_ID}
      # Twilio (optional)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_FROM=${TWILIO_FROM}
    depends_on:
      - agent

  # --- ¡NUEVO! WAHA (WhatsApp HTTP API) ---
  waha:
    image: devlikeapro/waha
    restart: always
    ports:
      - "3000:3000"
    environment:
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WHATSAPP_RESTART_ON_FAIL=True
      - WAHA_API_KEY=typeeasy_waha_key_2024
      - WAHA_DASHBOARD_USERNAME=admin
      - WAHA_DASHBOARD_PASSWORD=typeeasy
      # Configurar webhook automáticamente al iniciar
      - WAHA_WEBHOOK_URL=http://whatsapp_adapter:5002/waha_webhook
      - WAHA_WEBHOOK_EVENTS=message
    volumes:
      - ./waha_sessions:/app/.sessions
