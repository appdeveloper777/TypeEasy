services:
  # --- SERVICIO MYSQL ---
  mysql:
    image: mysql:8.0
    container_name: typeeasy_mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: test_db
    ports:
      - "3307:3306"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # --- SERVICIO DE LA API WEB (Sin cambios) ---
  api:
    depends_on:
      - mysql
    build:
      context: .
      dockerfile: src/Dockerfile
      target: api
    image: typeeasy-api
    ports:
      - "8080:8080"
    environment:
      - TYPEEASY_DEBUG=0
      # Configuración de MySQL - Cambia estos valores según tu servidor
      - MYSQL_HOST=mysql # Nombre del servicio MySQL en Docker
      - MYSQL_PORT=3306 # Puerto interno de MySQL
      - MYSQL_USER=root # Usuario de MySQL
      - MYSQL_PASSWORD=rootpassword # Contraseña de MySQL
      - MYSQL_DATABASE=meri # Nombre de la base de datos

  # --- SERVICIO DEL INTÉRPRETE (Sin cambios) ---
  typeeasy:
    build:
      context: .
      dockerfile: src/Dockerfile
      target: typeeasy
    volumes:
      - ./typeeasycode:/code
    environment:
      - TYPEEASY_DEBUG=0
    working_dir: /code
    entrypoint: [ "/typeeasy/typeeasy" ]

  # --- ¡NUEVO! SERVICIO DEL AGENTE (n8n) ---
  agent:
    build:
      context: .
      dockerfile: src/Dockerfile
      target: agent # Apunta a la nueva etapa 6 del Dockerfile
    image: typeeasy-agent
    ports:
      - "8081:8081" # Expone el puerto del agente
    environment:
      - TYPEEASY_DEBUG=0
    # El CMD del Dockerfile ya es ["./servidor_agent", "agente_chat_whatsapp.te"]

    depends_on:
      - nlu
      - api_mock

  # --- MOCK NLU service (simple HTTP adapter) ---
  nlu:
    build:
      context: ./tools/nlu_mock
    image: typeeasy-nlu-mock
    ports:
      - "5000:5000"

  # --- MOCK API service (menu provider) ---
  api_mock:
    build:
      context: ./tools/api_mock
    image: typeeasy-api-mock
    ports:
      - "5001:5001"

  whatsapp_adapter:
    build:
      context: ./tools/whatsapp_adapter
    image: typeeasy-whatsapp-adapter
    ports:
      - "5002:5002"
    environment:
      - AGENT_WEBHOOK=http://agent:8081/whatsapp_hook
      # For Twilio integration, set these in your environment or compose overrides:
      # - TWILIO_ACCOUNT_SID=your_sid
      # - TWILIO_AUTH_TOKEN=your_token
      # - TWILIO_FROM=whatsapp:+1415XXXXXXX
      # For Meta (WhatsApp Cloud API): set META_WHATSAPP_TOKEN and META_WHATSAPP_PHONE_ID
      # Optional Meta webhook verification and secret (set these in production)
      # - META_VERIFY_TOKEN=your_verify_token
      # - META_APP_SECRET=your_app_secret
      # - META_WHATSAPP_TOKEN=your_graph_api_token
      # - META_WHATSAPP_PHONE_ID=your_phone_id
    depends_on:
      - agent
